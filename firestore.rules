rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function isSignedIn() { return request.auth != null; }
    function isAdmin() { return isSignedIn() && request.auth.token.role == 'admin'; }
    function isSupervisor() { return isSignedIn() && (request.auth.token.role in ['admin','supervisor']); }
    function isWorker() { return isSignedIn() && (request.auth.token.role in ['admin','supervisor','worker']); }

    match /users/{uid} {
      allow read: if isSignedIn() && (uid == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    match /rates/{doc} {
      allow read: if isSignedIn();
      // Only admins OR a privileged function may write
      allow write: if isAdmin() || (request.auth.token.functionWrite == true);
    }

    match /taskTypes/{id} {
      allow read: if isSignedIn();
      allow write: if isSupervisor();
    }

    match /materialsCatalog/{sku} {
      allow read: if isSignedIn();
      allow write: if isSupervisor();
    }

    match /jobs/{jobId} {
      allow read: if isWorker();
      allow write: if isSupervisor(); // supervisors/admins manage jobs

      // Materials under a job
      match /materials/{materialId} {
        allow read: if isWorker();
        // Clients can propose sku, name, unitCost, quantity â€” BUT NOT subtotal
        allow create, update: if isSupervisor()
          && !('subtotal' in request.resource.data.diff(resource.data).affectedKeys());
        // Only Functions can set subtotal
        allow update: if request.auth.token.functionWrite == true;
      }

      // Sessions under a job
      match /sessions/{sessionId} {
        allow read: if isWorker();

        // Workers can create/update sessions they own (not computed fields)
        allow create, update: if isWorker()
          && request.resource.data.userId == request.auth.uid
          && !('durationSec' in request.resource.data.diff(resource.data).affectedKeys())
          && !('laborCost' in request.resource.data.diff(resource.data).affectedKeys());

        // Supervisors/Admins may edit any non-computed fields
        allow update: if isSupervisor()
          && !('durationSec' in request.resource.data.diff(resource.data).affectedKeys())
          && !('laborCost' in request.resource.data.diff(resource.data).affectedKeys());

        // Only Functions can write computed fields
        allow update: if request.auth.token.functionWrite == true;
      }
    }

    // Optional: aggregates/auditLogs read for all authed; write by functions
    match /aggregates/{doc} {
      allow read: if isSignedIn();
      allow write: if request.auth.token.functionWrite == true;
    }
    match /auditLogs/{doc} {
      allow read: if isAdmin();
      allow write: if request.auth.token.functionWrite == true;
    }
  }
}