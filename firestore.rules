rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Admins and Supervisors can list all users. Users can only read their own document.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || request.auth.token.role == 'admin';
      allow delete: if request.auth.token.role == 'admin';
      allow create: if request.auth.token.role == 'admin';
      allow list: if request.auth.token.role == 'admin' || request.auth.token.role == 'supervisor';
    }

    // Admins can manage core data. All authenticated users can read.
    match /materialsCatalog/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'admin';
    }
    match /taskTypes/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'admin';
    }
    match /rates/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'admin';
    }

    // --- Jobs & Subcollections ---
    // Any authenticated user can create a job.
    // Only admins or supervisors can delete jobs.
    match /jobs/{jobId} {
      allow read, create, update: if request.auth != null;
      allow delete: if request.auth.token.role == 'admin' || request.auth.token.role == 'supervisor';

        // Any authenticated user can create/update materials and sessions for a job.
        match /materials/{materialId} {
            allow read, write: if request.auth != null;
        }
        match /sessions/{sessionId} {
            allow read, write: if request.auth != null;
        }
    }
    
    // Nightly aggregates are admin-only
    match /aggregates/{aggId} {
        allow read, write: if request.auth.token.role == 'admin';
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
